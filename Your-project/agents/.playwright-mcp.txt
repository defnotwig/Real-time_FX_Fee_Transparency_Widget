# Playwright MCP Configuration

> Model Context Protocol configuration for automated browser testing and UI validation

---

## Purpose
Configure Playwright for automated end-to-end testing, visual regression testing, and UI validation.

---

## Configuration

### playwright.config.ts
```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: [
    ['html'],
    ['json', { outputFile: 'test-results/results.json' }],
    ['junit', { outputFile: 'test-results/junit.xml' }]
  ],
  
  use: {
    baseURL: process.env.BASE_URL || 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 12'] },
    },
  ],

  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
});
```

---

## Test Structure

### Directory Layout
```
tests/
├── e2e/
│   ├── auth/
│   │   ├── login.spec.ts
│   │   ├── signup.spec.ts
│   │   └── logout.spec.ts
│   ├── user/
│   │   ├── profile.spec.ts
│   │   └── settings.spec.ts
│   ├── payment/
│   │   └── checkout.spec.ts
│   └── fixtures/
│       ├── test-data.ts
│       └── helpers.ts
└── visual/
    ├── components/
    │   ├── button.spec.ts
    │   └── modal.spec.ts
    └── pages/
        ├── homepage.spec.ts
        └── dashboard.spec.ts
```

---

## Test Patterns

### Basic Test
```typescript
import { test, expect } from '@playwright/test';

test('user can login', async ({ page }) => {
  await page.goto('/login');
  
  await page.fill('input[name="email"]', 'test@example.com');
  await page.fill('input[name="password"]', 'password123');
  await page.click('button[type="submit"]');
  
  await expect(page).toHaveURL('/dashboard');
  await expect(page.locator('h1')).toContainText('Dashboard');
});
```

### Page Object Model
```typescript
// pages/login.page.ts
export class LoginPage {
  constructor(private page: Page) {}

  async goto() {
    await this.page.goto('/login');
  }

  async login(email: string, password: string) {
    await this.page.fill('input[name="email"]', email);
    await this.page.fill('input[name="password"]', password);
    await this.page.click('button[type="submit"]');
  }

  async getErrorMessage() {
    return await this.page.locator('.error-message').textContent();
  }
}

// login.spec.ts
test('invalid credentials show error', async ({ page }) => {
  const loginPage = new LoginPage(page);
  
  await loginPage.goto();
  await loginPage.login('invalid@example.com', 'wrongpassword');
  
  const error = await loginPage.getErrorMessage();
  expect(error).toContain('Invalid credentials');
});
```

### Fixtures for Reusable Setup
```typescript
// fixtures/auth.ts
import { test as base } from '@playwright/test';

type Fixtures = {
  authenticatedPage: Page;
};

export const test = base.extend<Fixtures>({
  authenticatedPage: async ({ page }, use) => {
    // Login before each test
    await page.goto('/login');
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'password123');
    await page.click('button[type="submit"]');
    await page.waitForURL('/dashboard');
    
    await use(page);
  },
});

// Usage
test('user can view profile', async ({ authenticatedPage }) => {
  await authenticatedPage.goto('/profile');
  await expect(authenticatedPage.locator('h1')).toContainText('Profile');
});
```

---

## Visual Regression Testing

### Screenshot Comparison
```typescript
test('homepage looks correct', async ({ page }) => {
  await page.goto('/');
  
  // Take screenshot and compare
  await expect(page).toHaveScreenshot('homepage.png', {
    fullPage: true,
    maxDiffPixels: 100,
  });
});

test('button has correct styling', async ({ page }) => {
  await page.goto('/components');
  
  const button = page.locator('button.primary');
  await expect(button).toHaveScreenshot('primary-button.png');
});
```

### Multiple Viewports
```typescript
const viewports = [
  { width: 375, height: 667, name: 'mobile' },
  { width: 768, height: 1024, name: 'tablet' },
  { width: 1920, height: 1080, name: 'desktop' }
];

for (const viewport of viewports) {
  test(`homepage looks correct on ${viewport.name}`, async ({ page }) => {
    await page.setViewportSize(viewport);
    await page.goto('/');
    
    await expect(page).toHaveScreenshot(`homepage-${viewport.name}.png`, {
      fullPage: true,
    });
  });
}
```

---

## API Testing with Playwright

### Mock API Responses
```typescript
test('handles API error gracefully', async ({ page }) => {
  // Intercept API call and return error
  await page.route('**/api/users', route => {
    route.fulfill({
      status: 500,
      body: JSON.stringify({ error: 'Internal server error' })
    });
  });
  
  await page.goto('/users');
  
  await expect(page.locator('.error')).toContainText('Failed to load users');
});
```

### Test API Endpoints
```typescript
import { test, expect } from '@playwright/test';

test('POST /api/users creates user', async ({ request }) => {
  const response = await request.post('/api/users', {
    data: {
      name: 'John Doe',
      email: 'john@example.com'
    }
  });
  
  expect(response.status()).toBe(201);
  
  const body = await response.json();
  expect(body.data.name).toBe('John Doe');
  expect(body.data.email).toBe('john@example.com');
});
```

---

## Accessibility Testing

```typescript
import { test, expect } from '@playwright/test';
import AxeBuilder from '@axe-core/playwright';

test('homepage has no accessibility violations', async ({ page }) => {
  await page.goto('/');
  
  const accessibilityScanResults = await new AxeBuilder({ page })
    .analyze();
  
  expect(accessibilityScanResults.violations).toEqual([]);
});

test('form is accessible', async ({ page }) => {
  await page.goto('/signup');
  
  const accessibilityScanResults = await new AxeBuilder({ page })
    .include('#signup-form')
    .analyze();
  
  expect(accessibilityScanResults.violations).toEqual([]);
});
```

---

## Performance Testing

```typescript
test('page loads within acceptable time', async ({ page }) => {
  const startTime = Date.now();
  
  await page.goto('/');
  await page.waitForLoadState('networkidle');
  
  const loadTime = Date.now() - startTime;
  
  expect(loadTime).toBeLessThan(3000); // 3 seconds
});

test('API response time is acceptable', async ({ request }) => {
  const startTime = Date.now();
  
  const response = await request.get('/api/users');
  
  const responseTime = Date.now() - startTime;
  
  expect(response.status()).toBe(200);
  expect(responseTime).toBeLessThan(500); // 500ms
});
```

---

## CI/CD Integration

### GitHub Actions
```yaml
# .github/workflows/e2e.yml
name: E2E Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install Playwright
        run: npx playwright install --with-deps
        
      - name: Run E2E tests
        run: npm run test:e2e
        env:
          BASE_URL: http://localhost:3000
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
```

---

## Best Practices

### 1. Wait for Elements
```typescript
// ❌ Don't use arbitrary timeouts
await page.waitForTimeout(3000);

// ✅ Wait for specific conditions
await page.waitForSelector('.content');
await page.waitForLoadState('networkidle');
await page.waitForURL('/dashboard');
```

### 2. Use Data Test IDs
```typescript
// ❌ Fragile selectors
await page.click('div > button.primary');

// ✅ Stable test IDs
await page.click('[data-testid="submit-button"]');
```

### 3. Isolate Tests
```typescript
// ✅ Each test should be independent
test.beforeEach(async ({ page }) => {
  // Reset state
  await page.goto('/');
  await clearDatabase();
});
```

### 4. Handle Flakiness
```typescript
// Use auto-waiting
await expect(page.locator('.result')).toBeVisible();

// Retry on failure
test.describe.configure({ retries: 2 });

// Use proper assertions
await expect(page.locator('.count')).toHaveText('5', { timeout: 10000 });
```

---

## Common Patterns

### Authentication Flow
```typescript
test.describe('authenticated routes', () => {
  test.use({ storageState: 'auth.json' });
  
  test('can access profile', async ({ page }) => {
    await page.goto('/profile');
    await expect(page).toHaveURL('/profile');
  });
});

// Generate auth state
test('generate auth state', async ({ page, context }) => {
  await page.goto('/login');
  await page.fill('input[name="email"]', 'test@example.com');
  await page.fill('input[name="password"]', 'password123');
  await page.click('button[type="submit"]');
  await page.waitForURL('/dashboard');
  
  await context.storageState({ path: 'auth.json' });
});
```

### File Upload
```typescript
test('can upload file', async ({ page }) => {
  await page.goto('/upload');
  
  const fileInput = page.locator('input[type="file"]');
  await fileInput.setInputFiles('path/to/file.pdf');
  
  await page.click('button[type="submit"]');
  
  await expect(page.locator('.success')).toBeVisible();
});
```

### Drag and Drop
```typescript
test('can reorder items', async ({ page }) => {
  await page.goto('/dashboard');
  
  const source = page.locator('[data-testid="item-1"]');
  const target = page.locator('[data-testid="item-2"]');
  
  await source.dragTo(target);
  
  // Verify new order
  const items = await page.locator('[data-testid^="item-"]').allTextContents();
  expect(items[0]).toBe('Item 2');
  expect(items[1]).toBe('Item 1');
});
```

---

## Debugging

### Debug Mode
```bash
# Run in debug mode
npx playwright test --debug

# Debug specific test
npx playwright test login.spec.ts --debug

# Headed mode
npx playwright test --headed

# Slow motion
npx playwright test --headed --slow-mo=1000
```

### Trace Viewer
```typescript
// Enable tracing
use: {
  trace: 'on-first-retry',
}

// View trace
npx playwright show-trace trace.zip
```

### Codegen
```bash
# Generate tests
npx playwright codegen http://localhost:3000

# Generate with device emulation
npx playwright codegen --device="iPhone 12" http://localhost:3000
```

---

## MCP Commands for Claude

### When asked to test UI:
```
1. Read test specifications or user requirements
2. Create Playwright test using patterns above
3. Run test and analyze results
4. Take screenshots if visual validation needed
5. Report findings with specific line numbers and suggestions
```

### Visual comparison workflow:
```
1. Take baseline screenshots on first run
2. Make UI changes
3. Run tests again
4. Compare screenshots
5. Report differences with pixel diff count
6. Approve or reject visual changes
```